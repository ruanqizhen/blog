---
title: "调用动态链接库 4 - 结构型参数的设置"
date: "2008-04-09"
tags: 
  - "我和labview"
---

[https://lv.qizhen.xyz/external\_call\_dll](https://lv.qizhen.xyz/external_call_dll)
```
    C 语言中的结构（struct），在一些简单情况下，可以和 LabVIEW 中的 Cluster 相对应。但是，对于比较复杂的情况，LabVIEW 中的 Cluster 要做适当调整，才能够对应起来。

    在讨论结构型参数的映射前，一定要先了解一下[字节对齐](http://www.google.cn/search?hl=zh-CN&q=%E5%AD%97%E8%8A%82%E5%AF%B9%E9%BD%90&btnG=Google+%E6%90%9C%E7%B4%A2&meta=)的概念。我在这里只做一个简单说明，详细内容可以查找相关的专题文章。  
    C 语言中的一个结构 typedef struct { char a; int b} MyStct;  结构中的元素a所在的地址是：0xAAAA0000，b 的存放地址是与结构的字节对齐设置相关的。如果采用1字节对齐，b是紧挨着a存放的，b的地址就是：0xAAAA0001；如果采用2字节对齐，b的存放地址是紧挨着a的第一个偶数地址，也就是：0xAAAA0002；如果采用4字节对齐，b的存放地址是紧挨着a的第一个4整数倍地址，也就是：0xAAAA0004……  
    C 语言的字节对齐数可以由 #pragma pack 指令指定，也可以在工程属性里指定。但是 LabVIEW 的 Cluster 只能是1字节对齐的。因此，C 语言中，非1字节对齐的结构与Cluster对应时，一定要做适当调整。比如，结构 typedef struct { char a; int b} MyStct;  是2字节对齐的，那么，对应的LabVIEW Cluster 第一个元素还应该是 I8 型的a，但是，不能紧接着就放b，因为C语言中，b的起始地址不是紧挨着a的，他们中间还有一个无意义的数据，C的结构体虽然表现不出来，LabVIEW中却需要把它考虑进去。  
    如果是自己编写一个DLL给LabVIEW使用，为了方便，可以把C代码中所有的结构都设为1字节对齐。

    C 语言的结构中如果还嵌套了数组，是不能直接对应于LabVIEW中嵌套了数组的Cluster的。在LabVIEW中，只能把数组的元素都拆开来放在Cluster中。

    下面是一些对应的实例：

<table style="border-collapse:collapse;" border="0" width="545"><colgroup><col style="width:84px;"> <col style="width:214px;"> <col style="width:230px;"></colgroup><tbody valign="top"><tr style="height:22px;"><td style="border:silver 0.5pt solid;" valign="center" width="342"><strong>C</strong></td><td style="border-right:silver 0.5pt solid;border-top:silver 0.5pt solid;border-bottom:silver 0.5pt solid;border-left-style:none;" width="195"><strong>LabVIEW</strong></td></tr><tr style="height:22px;"><td style="border-right:silver 0.5pt solid;border-left:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;" valign="center" width="342"><p align="left">#pragma pack (1)<br>typedef struct { char a; int b} MyStct;<br>MyStct* testStruct;</p></td><td style="border-right:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;border-left-style:none;" width="195"><a href="http://byfiles.storage.msn.com/y1pIcO_924THof8g9SPZtAYBQ19vizW929tnBCHRFqqilKJ2JWxsnLfn1F58XTATFGIucBEQtaBaZE?PARTNER=WRITER"><img src="http://byfiles.storage.msn.com/y1pIcO_924THoeZYKyGo9U3GBYg1AQzcqE0Qlav9GpWleBMliPhGkpueyOzlrC-hL9mu1eMQJ8j6No?PARTNER=WRITER" border="0"></a></td></tr><tr style="height:21px;"><td style="border-right:silver 0.5pt solid;border-left:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;" valign="center" width="342"><p align="left">#pragma pack (2)<br>typedef struct { char a; int b} MyStct;<br>MyStct* testStruct;</p></td><td style="border-right:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;border-left-style:none;" width="195"><a href="http://byfiles.storage.msn.com/y1pIcO_924THoehf1UlUcN_pCJ26RDxShJnnFB005piWSnZKwd8QWx46CMMXWo2Ql-UzYrxfL5sO44?PARTNER=WRITER"><img src="http://byfiles.storage.msn.com/y1pIcO_924THodbSuud3ZScEin6Gr48B-Mdye9352ZJfQRbgDfXz_L4HSn70RqZbEpWtmVq4kZGei0?PARTNER=WRITER" border="0"></a></td></tr><tr style="height:28px;"><td style="border-right:silver 0.5pt solid;border-left:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;" valign="center" width="342"><p align="left">#pragma pack (4)<br>typedef struct { char a; int b} MyStct;<br>MyStct* testStruct;</p></td><td style="border-right:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;border-left-style:none;" width="195"><a href="http://byfiles.storage.msn.com/y1pIcO_924THof78CPrt6CfjQoDF5wYlHTZjz00g8H14fkkfw-gYGBRfBXCgN-FnGZsMnX7aUCb5_E?PARTNER=WRITER"><img src="http://byfiles.storage.msn.com/y1pIcO_924THoeyinvvkoBtEjhyrrN1zLklOEC7gKOtIDvCxPer41FHzjPHe_wYZguLpZ8JiT4Tbkw?PARTNER=WRITER" border="0"></a></td></tr><tr style="height:28px;"><td style="border-right:silver 0.5pt solid;border-left:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;" valign="center" width="342"><p align="left">#pragma pack (1)<br>typedef struct { char a; char* str; int b} MyStct;<br>MyStct* testStruct;</p></td><td style="border-right:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;border-left-style:none;" width="195"><a href="http://byfiles.storage.msn.com/y1pIcO_924THoc1gVpsLyUVR28eZBSo99BnjW6XhtGM665M3ZAy-1t7P1oPZhO3jmyFTCO3Zg_OVKk?PARTNER=WRITER"><img src="http://byfiles.storage.msn.com/y1pIcO_924THoeQsG1b5-UiugbbP7Jk8uAjrey8c-zkh-fvv2aVzpm3LnxcsTDweQQ0hurCI5AnxFc?PARTNER=WRITER" border="0"></a></td></tr><tr style="height:28px;"><td style="border-right:silver 0.5pt solid;border-left:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;" valign="center" width="342"><p align="left">#pragma pack (1)<br>typedef struct { char a; char str[5]; int b} MyStct;<br>MyStct* testStruct;</p></td><td style="border-right:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;border-left-style:none;" width="195"><a href="http://byfiles.storage.msn.com/y1pIcO_924THoeP7oOBJYfdeO9dqun8p2XR5e1bdI4XgXKlJyjv3lgQLXSuNrT1CQ1qeCnFl7pe88Y?PARTNER=WRITER"><img src="http://byfiles.storage.msn.com/y1pIcO_924THoc_f3MkJezqU4C-it1fYrl49UhTY5kZ-09rrHyGlaHo4mUUVt5g4n_T3xYkzeyGWKI?PARTNER=WRITER" border="0"></a></td></tr></tbody></table>

    上面这个表中有两点需要注意的：  
    一是，表格中的第四个例子，结构中含有一个指针，LabVIEW中的Cluster只能用一个U32数值（32位系统上，64位系统上使用U64）来表示指针的地址。不能把指针指向的内容放到Cluser中去。后面的章节再讨论当我们在LabVIEW中得到了一个数据的地址后，如何从这个地址中把数据拿出来。  
    第二，上面C语言中声明的 testStruct 变量，是指向结构的指针。就是说C函数的变量类型为结构的指针时，才能在LabVIEW中使用Cluster与之对应。CLN节点的配置面板中，没有一个专门的参数类型叫做“struct”或者“Cluster”，选择“Adapt to Type”就可以了。  
    如果参数的类型就是结构而非指针，考虑到C函数参数的压栈顺序，把一个结构体作为参数传给函数，等价于把结构中每个元素分别作为参数传递给函数。下面是一个例子：

<table style="border-collapse:collapse;" border="0"><colgroup><col style="width:84px;"> <col style="width:214px;"> <col style="width:230px;"></colgroup><tbody valign="top"><tr style="height:22px;"><td style="border:silver 0.5pt solid;" valign="center"><p style="text-align:center;"><span style="font-size:9pt;"><strong><span style="font-family:宋体;">输入</span><span style="font-family:times new roman;">/</span><span style="font-family:宋体;">输出</span></strong></span></p></td><td style="border-right:silver 0.5pt solid;border-top:silver 0.5pt solid;border-bottom:silver 0.5pt solid;border-left-style:none;"><p style="text-align:center;"><span style="font-size:9pt;color:black;font-family:宋体;">输入</span></p></td><td style="border-right:silver 0.5pt solid;border-top:silver 0.5pt solid;border-bottom:silver 0.5pt solid;border-left-style:none;"><p style="text-align:center;"><span style="font-size:9pt;color:black;font-family:宋体;">输出或兼作输入输出</span></p></td></tr><tr style="height:22px;"><td style="border-right:silver 0.5pt solid;border-left:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;" valign="center"><p style="text-align:center;"><span style="font-size:9pt;"><strong><span style="font-family:times new roman;">C</span><span style="font-family:宋体;">语言声明</span></strong></span></p></td><td style="border-right:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;border-left-style:none;"><p align="left">typedef struct{int left; int top;} Position;<br>long TestStructure(Position inPos);</p></td><td style="border-right:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;border-left-style:none;"><p align="left">typedef struct{int left; int top;} Position;<br>long TestStructure(Position *pos);</p></td></tr><tr style="height:21px;"><td style="border-right:silver 0.5pt solid;border-left:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;" valign="center"><p style="text-align:center;"><span style="font-size:9pt;"><strong><span style="font-family:times new roman;">LabVIEW<br></span><span style="font-family:宋体;">中的配置</span></strong></span></p></td><td style="border-right:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;border-left-style:none;"><p style="text-align:center;"><a href="http://byfiles.storage.msn.com/y1pIcO_924THocmuZCdAW9fRKtv1HSM6HPqfq-5ily7xquBIl_RZ4mJjF68H2mLoroRb4WlW1XlMWU?PARTNER=WRITER"><img src="http://byfiles.storage.msn.com/y1pIcO_924THocI_T9MvCXXnPZPHPL-cbCBv25GNUcF6sVNKCNueaNyDOSKgs-5VUlOELfimxBN84c?PARTNER=WRITER" border="0"></a>&nbsp;</p></td><td style="border-right:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;border-left-style:none;"><p style="text-align:center;"><a href="http://byfiles.storage.msn.com/y1pIcO_924THodStphb5N9L8wnVxAS_5L4ZQCwG6iqYrBuBF6X8AMYpBSBADcwnpnMXU7y2e-63DeU?PARTNER=WRITER"><img src="http://byfiles.storage.msn.com/y1pIcO_924THofIhXfVX26fccZpl7exiu8XO7c9M_Gf8rswhSsSvUmQxu3xQLd47W8raz-ymRQ_BMY?PARTNER=WRITER" border="0"></a>&nbsp;</p></td></tr><tr style="height:28px;"><td style="border-right:silver 0.5pt solid;border-left:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;" valign="center"><p style="text-align:center;"><span style="font-size:9pt;"><strong><span style="font-family:times new roman;">LabVIEW<br></span><span style="font-family:宋体;">的使用</span></strong></span></p></td><td style="border-right:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;border-left-style:none;"><p style="text-align:center;">&nbsp;<a href="http://byfiles.storage.msn.com/y1pIcO_924THofXv99ibU0UDpJIV0M7UiYBZZMODz0WJ7SkP9sau2pBDs-pzhqVChGRRcqKjqtq19Q?PARTNER=WRITER"><img src="http://byfiles.storage.msn.com/y1pIcO_924THodyuxsZUUAbjNFiY0YHEoBraUwVgQWtsbIsfqVCdV-aYp0z7jwo45GYKF7ca9cO5aA?PARTNER=WRITER" border="0"></a></p></td><td style="border-right:silver 0.5pt solid;border-top-style:none;border-bottom:silver 0.5pt solid;border-left-style:none;"><p style="text-align:center;">&nbsp;<a href="http://byfiles.storage.msn.com/y1pIcO_924THofKd5tH5QzUlmIFf0CAegYIvoy83Dp0qzKcevnIPYbgrtccNiNbl7ZKChOxPEzOl2Q?PARTNER=WRITER"><img src="http://byfiles.storage.msn.com/y1pIcO_924THodRS1kRTgPdfK1csPYaq2XCZCfaa3pj7LWe04EgXYI_CX9igejQi3hKu7id0R8NcnY?PARTNER=WRITER" border="0"></a></p></td></tr></tbody></table>

 [《我和 LabVIEW》目录](https://lv.qizhen.xyz/)
```